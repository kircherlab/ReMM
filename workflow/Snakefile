from os.path import join
from glob import glob
import datetime
import pandas as pd


##### check snakemake min version #####

from snakemake.utils import min_version

min_version("6.0.5")


##### load config and sample sheets #####


configfile: "config/config.yaml"
configfile: "config/featuresConfig38.json"


# TODO implement validation
# validate(config, schema="../schemas/config.schema.yaml")

##### all rules #####


##### include files #####


include: "rules/features.smk"
include: "rules/process/getUtils.smk"
include: "rules/process/folds.smk"
include: "rules/process/positiveVariants.smk"
include: "rules/process/negativeVariants.smk"
include: "rules/process/annotateJannovar.smk"
include: "rules/process/createModelData.smk"
include: "rules/model/parSMURF.smk"


## ancient is there to not rerun, delete sometime (createPropertyFile and createSingleFeatureVCF)


rule annotateFeatures:
    input:
        f="results/features/feature_sets/{feature_set}.vcf.gz",
        f_idx="results/features/feature_sets/{feature_set}.vcf.gz.tbi",
        n="results/variants/hg38/SNVs.hg38.{type}.refseq.filtered.vcf.gz",
    output:
        "results/variants/hg38/SNVs.hg38.{type}.{feature_set}.tsv.gz",
    shell:
        """
        java -Xmx2g -jar workflow/bin/attributedb-cli-0.0.1-jar-with-dependencies.jar annotate-vcf \
        --annotation-vcf {input.f} --file {input.n} | bgzip -c > {output}
        """
